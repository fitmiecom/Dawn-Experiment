
{{ 'component-slider.css' | asset_url | stylesheet_tag }}
{{ 'component-instafeed.css' | asset_url | stylesheet_tag }}

<instafeed class="instafeed-section" style="--section-padding-top: {{ section.settings.padding_top }}px; --section-padding-bottom: {{ section.settings.padding_bottom }}px;">
  <div class="instafeed-container">
    <div class="instagram-header" style="text-align: {{ section.settings.content_alignment }};">
      {%- if section.settings.heading != blank -%}
        <h2 class="instagram-heading">
          {{ section.settings.heading | escape }}
        </h2>
      {%- endif -%}
      
      {%- if section.settings.subheading != blank -%}
        <div class="instagram-subheading">
          {{ section.settings.subheading | escape }}
        </div>
      {%- endif -%}
    </div>

    {%- if section.blocks.size > 0 -%}
      <div class="instagram-grid" style="--instagram-grid-gap: {{ section.settings.grid_gap }}px; --item-per-row: {{ section.settings.item_per_row }};">
        {%- for block in section.blocks -%}

          <div class="instagram-item"
               {{ block.shopify_attributes }}
               data-modal-trigger
               data-block-id="{{ block.id }}"
               data-block-index="{{ forloop.index0 }}"
               data-title="{{ block.settings.title | escape }}"
               data-description="{{ block.settings.description | strip_html | escape }}"
               data-tag="{{ block.settings.tag | escape }}"
               data-product-url="{{ block.settings.product.url | default: '' }}"
               data-product-title="{{ block.settings.product.title | default: '' }}"
               {% if block.settings.image %}
               data-image-url="{{ block.settings.image | image_url: width: 800 }}"
               {% endif %}
               {% if block.settings.video %}
               data-video-url="{{ block.settings.video.sources[0].url }}"
               data-video-type="{% if block.settings.video contains 'youtube' %}youtube{% elsif block.settings.video contains 'vimeo' %}vimeo{% else %}mp4{% endif %}"

               {% endif %}
               data-has-video="{% if block.settings.video != blank %}true{% else %}false{% endif %}">
            {%- if block.settings.image != blank or block.settings.video != blank -%}
              <div class="instagram-media" data-block-id="{{ block.id }}" data-block-index="{{ forloop.index0 }}">
                {%- if block.settings.video != blank -%}
                  {%- if block.settings.video contains 'youtube' or block.settings.video contains 'vimeo' -%}
                    <div class="instagram-video-placeholder" style="background-image: url('{{ block.settings.image | image_url: width: 600 }}');">
                      <div class="instagram-video-play-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M8 5V19L19 12L8 5Z" fill="white"/>
                        </svg>
                      </div>
                    </div>
                  {%- else -%}

										{{ block.settings.video | video_tag: image_size: '1100x', autoplay: true, loop: true, controls: true, muted: true, class: 'instagram-video' }}
                  {%- endif -%}
                {%- elsif block.settings.image != blank -%}
                  {{ block.settings.image | image_url: width: 600 | image_tag: loading: 'lazy', alt: block.settings.image.alt | escape }}
                {%- endif -%}
              </div>
              {% else %}
              <div class="instagram-media-placeholder">
                {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
              </div>
            {%- endif -%}

            <div class="instagram-overlay">
              {% unless block.settings.show_title -%}
                 <svg class="icon icon-instagram" viewBox="0 0 20 20"><path fill="currentColor" fill-rule="evenodd" d="M13.23 3.492c-.84-.037-1.096-.046-3.23-.046-2.144 0-2.39.01-3.238.055-.776.027-1.195.164-1.487.273a2.4 2.4 0 0 0-.912.593 2.5 2.5 0 0 0-.602.922c-.11.282-.238.702-.274 1.486-.046.84-.046 1.095-.046 3.23s.01 2.39.046 3.229c.004.51.097 1.016.274 1.495.145.365.319.639.602.913.282.282.538.456.92.602.474.176.974.268 1.479.273.848.046 1.103.046 3.238.046s2.39-.01 3.23-.046c.784-.036 1.203-.164 1.486-.273.374-.146.648-.329.921-.602.283-.283.447-.548.602-.922.177-.476.27-.979.274-1.486.037-.84.046-1.095.046-3.23s-.01-2.39-.055-3.229c-.027-.784-.164-1.204-.274-1.495a2.4 2.4 0 0 0-.593-.913 2.6 2.6 0 0 0-.92-.602c-.284-.11-.703-.237-1.488-.273ZM6.697 2.05c.857-.036 1.131-.045 3.302-.045a63 63 0 0 1 3.302.045c.664.014 1.321.14 1.943.374a4 4 0 0 1 1.414.922c.41.397.728.88.93 1.414.23.622.354 1.279.365 1.942C18 7.56 18 7.824 18 10.005c0 2.17-.01 2.444-.046 3.292-.036.858-.173 1.442-.374 1.943-.2.53-.474.976-.92 1.423a3.9 3.9 0 0 1-1.415.922c-.51.191-1.095.337-1.943.374-.857.036-1.122.045-3.302.045-2.171 0-2.445-.009-3.302-.055-.849-.027-1.432-.164-1.943-.364a4.15 4.15 0 0 1-1.414-.922 4.1 4.1 0 0 1-.93-1.423c-.183-.51-.329-1.085-.365-1.943C2.009 12.45 2 12.167 2 10.004c0-2.161 0-2.435.055-3.302.027-.848.164-1.432.365-1.942a4.4 4.4 0 0 1 .92-1.414 4.2 4.2 0 0 1 1.415-.93c.51-.183 1.094-.33 1.943-.366Zm.427 4.806a4.105 4.105 0 1 1 5.805 5.805 4.105 4.105 0 0 1-5.805-5.805m1.882 5.371a2.668 2.668 0 1 0 2.042-4.93 2.668 2.668 0 0 0-2.042 4.93m5.922-5.942a.958.958 0 1 1-1.355-1.355.958.958 0 0 1 1.355 1.355" clip-rule="evenodd"/></svg>
              {% endunless %}
              <div class="instagram-content" style="display: {{ block.settings.show_title | replace: 'true', 'block' | replace: 'false', 'none' }};">

                  {%- if block.settings.title != blank -%}
                    <h3 class="instagram-title">
                      {{ block.settings.title | escape }}
                    </h3>
                  {%- endif -%}

                  {%- if block.settings.description != blank -%}
                    <div class="instagram-description">
                      {{ block.settings.description }}
                    </div>
                  {%- endif -%}

                  <div class="instagram-meta">
                    {%- if block.settings.tag != blank -%}
                      <span class="instagram-tag">
                        {{ block.settings.tag | escape }}
                      </span>
                    {%- endif -%}
                    {%- if block.settings.product != blank -%}
                              <a href="{{ block.settings.product.url }}" class="instagram-product-link">
                      View Product
                      </a>
                    {%- endif -%}
                  </div>

                </div>
              </div>
              {%- if block.settings.product_list != blank -%}
              <div class="instagram-products-list js-instagram-products-list" style="width: 0; height: 0; overflow: hidden;">
                {% for product in block.settings.product_list %}
                  <div class="instagram-product-item">
                    <img src="{{ product.featured_image | image_url: width: 400 }}" alt="{{ product.title }}" width="{{product.featured_image.width}}" height="{{product.featured_image.height}}" class="instagram-product-image">
                    <a href="{{ product.url }}" class="instagram-product-link">
                      {{ product.title }}
                    </a>
                  </div>
                {% endfor %}
              </div>
              {%- endif -%}
            </div>
        {%- endfor -%}
      </div>
    {%- endif -%}
  </div>
</instafeed>

<!-- Instagram Modal Container -->
<instagram-modal 
  id="instagram-modal-{{ section.id }}"
  class="instagram-modal-container"
  data-section-id="{{ section.id }}"
  data-total-blocks="{{ section.blocks.size }}">
{% comment %}
	<button class="close-instagram-modal">
		<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
			<path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
		</svg>
	</button>
	<div class="instagram-modal-content">
		<div class="instagram-modal-slider">
			{% for block in section.blocks %}
			<div class="instagram-modal-slide" 111111>
					<div class="instagram-modal-media">
						{% if block.settings.image != blank %}
							{{ block.settings.image | image_url: width: 600 | image_tag: loading: 'lazy', alt: block.settings.image.alt | escape }}
						{% endif %}
					</div>
				</div>
			{% endfor %}
		</div>
	</div>

	<div class="slide-controls">
		<button class="prev-instagram-modal">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
		</button>
		<button class="next-instagram-modal">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
		</button>
	</div>
	 {% endcomment %}
</instagram-modal>

<script>
class InstagramModal extends HTMLElement {
  constructor() {
    super();
    this.currentIndex = 0;
    this.totalBlocks = parseInt(this.dataset.totalBlocks) || 0;
    this.isOpen = false;
    this.currentVideo = null;
    this.isVideoMuted = true;
    this.isVideoPlaying = false;
    this.preloadedMedia = new Map();
    this.isPreloaded = false;

    this.init();
  }

  init() {
    this.createModalHTML();
    this.bindEvents();
    this.setupPreloading();
  }

  createModalHTML() {
    this.innerHTML = `
      <div class="instagram-modal-overlay" data-modal-overlay>
        <div class="instagram-modal-content">
          <button class="instagram-modal-close" data-modal-close>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          
          <div class="instagram-modal-slider">
            

            <div class="instagram-modal-slide-container">
              <div class="instagram-modal-slide">
                <div class="instagram-modal-media">
                <button class="instagram-modal-nav instagram-modal-prev" data-modal-prev>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="instagram-modal-nav instagram-modal-next" data-modal-next>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                  <div class="instagram-modal-image-container"></div>
                  <div class="instagram-modal-video-container" style="display: none;">
                    <video muted loop playsinline>
                      <source src="" type="video/mp4">
                    </video>
                    <div class="instagram-modal-video-controls">
                      <button class="instagram-modal-sound-btn" data-sound-toggle>
                        <svg class="sound-icon muted" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M15.54 8.46C16.4774 9.39764 17.004 10.6692 17.004 12C17.004 13.3308 16.4774 14.6024 15.54 15.54" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <svg class="sound-icon unmuted" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                          <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M23 9L17 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M17 9L23 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                      <button class="instagram-modal-play-btn" data-play-toggle>
                        <svg class="play-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                        </svg>
                        <svg class="pause-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                          <path d="M6 4H10V20H6V4Z" fill="currentColor"/>
                          <path d="M14 4H18V20H14V4Z" fill="currentColor"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="instagram-modal-indicators">
                    <span class="instagram-modal-counter">
                      <span class="current-slide">1</span> / <span class="total-slides">{{ section.blocks.size }}</span>
                    </span>
                  </div>
                </div>
                <div class="instagram-modal-info">
                  <h3 class="instagram-modal-title"></h3>
                  <div class="instagram-modal-description"></div>
                  <div class="instagram-modal-meta">
                    <span class="instagram-modal-tag"></span>
                  </div>
                  <div class="instagram-modal-products-list js-instagram-modal-products-list"></div>
                </div>
              </div>
            </div>


          </div>
        </div>
      </div>
    `;
    
    // Bind events after creating HTML
    this.bindModalEvents();
  }

  bindModalEvents() {
    // Modal close
    const closeBtn = this.querySelector('[data-modal-close]');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        this.closeModal();
      });
    }

    // Modal overlay close
    const overlay = this.querySelector('[data-modal-overlay]');
    if (overlay) {
      overlay.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          this.closeModal();
        }
      });
    }

    // Navigation
    const prevBtn = this.querySelector('[data-modal-prev]');
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        this.prevSlide();
      });
    }

    const nextBtn = this.querySelector('[data-modal-next]');
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        this.nextSlide();
      });
    }

    // Video controls
    const soundBtn = this.querySelector('[data-sound-toggle]');
    if (soundBtn) {
      soundBtn.addEventListener('click', () => {
        this.toggleSound();
      });
    }

    const playBtn = this.querySelector('[data-play-toggle]');
    if (playBtn) {
      playBtn.addEventListener('click', () => {
        this.togglePlay();
      });
    }
  }

  bindEvents() {
    // Modal triggers
    document.querySelectorAll('[data-modal-trigger]').forEach(trigger => {
      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        const index = parseInt(trigger.dataset.blockIndex);
        this.openModal(index);
      });
    });

    // Keyboard navigation (global)
    document.addEventListener('keydown', (e) => {
      if (!this.isOpen) return;
      
      switch(e.key) {
        case 'Escape':
          this.closeModal();
          break;
        case 'ArrowLeft':
          this.prevSlide();
          break;
        case 'ArrowRight':
          this.nextSlide();
          break;
      }
    });
  }

  setupPreloading() {
    // Create intersection observer to detect when section is visible
    const section = document.querySelector(`[data-section-id="${this.dataset.sectionId}"]`);
    if (!section) return;

    let preloadTimeout;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !this.isPreloaded) {
          // Debounce preloading to avoid multiple calls
          clearTimeout(preloadTimeout);
          preloadTimeout = setTimeout(() => {
            this.preloadAllMedia();
            observer.unobserve(entry.target);
          }, 100);
        }
      });
    }, {
      rootMargin: '200px', // Start preloading 200px before section comes into view
      threshold: 0.1
    });

    observer.observe(section);
  }

  preloadAllMedia() {
    if (this.isPreloaded) return;
    
    const triggers = document.querySelectorAll('[data-modal-trigger]');
    let loadedCount = 0;
    const totalItems = triggers.length;

    triggers.forEach((trigger, index) => {
      const imageUrl = trigger.dataset.imageUrl;
      const videoUrl = trigger.dataset.videoUrl;
      const videoType = trigger.dataset.videoType;
      const hasVideo = trigger.dataset.hasVideo === 'true';

      if (hasVideo && videoUrl) {
        if (videoType === 'youtube' || videoType === 'vimeo') {
          // For YouTube/Vimeo, just preload the image
          this.preloadImage(imageUrl, index, () => {
            loadedCount++;
            this.updatePreloadProgress(loadedCount, totalItems);
          });
        } else {
          // Preload MP4 video
          this.preloadVideo(videoUrl, imageUrl, index, () => {
            loadedCount++;
            this.updatePreloadProgress(loadedCount, totalItems);
          });
        }
      } else if (imageUrl) {
        // Preload image
        this.preloadImage(imageUrl, index, () => {
          loadedCount++;
          this.updatePreloadProgress(loadedCount, totalItems);
        });
      }
    });
  }

  preloadImage(imageUrl, index, callback) {
    const img = new Image();
    img.onload = () => {
      this.preloadedMedia.set(index, {
        type: 'image',
        element: img,
        url: imageUrl
      });
      callback();
    };
    img.onerror = () => {
      console.warn(`Failed to preload image: ${imageUrl}`);
      // Still mark as loaded to avoid infinite retries
      this.preloadedMedia.set(index, {
        type: 'image',
        element: null,
        url: imageUrl,
        failed: true
      });
      callback();
    };
    img.src = imageUrl;
  }

  preloadVideo(videoUrl, posterUrl, index, callback) {
    const video = document.createElement('video');
    video.muted = true;
    video.preload = 'metadata';

    if (posterUrl) {
      video.poster = posterUrl;
    }

    video.onloadedmetadata = () => {
      this.preloadedMedia.set(index, {
        type: 'video',
        element: video,
        url: videoUrl,
        poster: posterUrl
      });
      callback();
    };

    video.onerror = () => {
      console.warn(`Failed to preload video: ${videoUrl}`);
      // Still mark as loaded to avoid infinite retries
      this.preloadedMedia.set(index, {
        type: 'video',
        element: null,
        url: videoUrl,
        poster: posterUrl,
        failed: true
      });
      callback();
    };

    video.src = videoUrl;
  }

  updatePreloadProgress(loaded, total) {
    if (loaded >= total) {
      this.isPreloaded = true;
      console.log('Instagram modal media preloaded successfully');
      // Add a subtle indicator that content is ready
      this.addReadyIndicator();
    }
  }

  addReadyIndicator() {
    // Add a subtle visual indicator that content is preloaded
    const items = document.querySelectorAll('[data-modal-trigger]');
    items.forEach(item => {
      item.setAttribute('data-preload-ready', 'true');
    });
  }

  showLoadingState() {
    const mediaContainer = this.querySelector('.instagram-modal-media');
    if (mediaContainer) {
      mediaContainer.innerHTML = `
        <div class="instagram-modal-loading">
          <div class="instagram-modal-loading-spinner"></div>
          <p>Loading content...</p>
        </div>
      `;
    }
  }

  hideLoadingState() {
    const loadingElement = this.querySelector('.instagram-modal-loading');
    if (loadingElement) {
      loadingElement.remove();
    }
  }

  getEmbedUrl(url, type) {
    if (type === 'youtube') {
      // Extract YouTube video ID and create embed URL
      const videoId = this.extractYouTubeId(url);
      return `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}`;
    } else if (type === 'vimeo') {
      // Extract Vimeo video ID and create embed URL
      const videoId = this.extractVimeoId(url);
      return `https://player.vimeo.com/video/${videoId}?autoplay=1&muted=1&loop=1`;
    }
    return url;
  }

  extractYouTubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  extractVimeoId(url) {
    const regExp = /vimeo\.com\/([0-9]+)/;
    const match = url.match(regExp);
    return match ? match[1] : null;
  }

  openModal(index) {
    this.currentIndex = index;
    this.isOpen = true;
    this.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Ensure modal HTML is created before loading content
    if (!this.querySelector('.instagram-modal-content')) {
      this.createModalHTML();
    }
    
    // Show loading state if content isn't preloaded
    if (!this.isPreloaded) {
      this.showLoadingState();
    }
    
    this.loadSlide(index);
  }

  closeModal() {
    this.isOpen = false;
    this.classList.remove('active');
    document.body.style.overflow = '';
    this.pauseCurrentVideo();
  }

  loadSlide(index) {
    const triggers = document.querySelectorAll('[data-modal-trigger]');
    const trigger = triggers[index];
    
    if (!trigger) return;

    // Ensure modal elements exist
    let imageContainer = this.querySelector('.instagram-modal-image-container');
    let videoContainer = this.querySelector('.instagram-modal-video-container');
    let video = videoContainer?.querySelector('video');
    
    if (!imageContainer || !videoContainer) {
      console.warn('Modal elements not found, creating modal HTML first');
      this.createModalHTML();
      // Re-query elements after creation
      imageContainer = this.querySelector('.instagram-modal-image-container');
      videoContainer = this.querySelector('.instagram-modal-video-container');
      video = videoContainer?.querySelector('video');
      
      if (!imageContainer || !videoContainer) {
        console.error('Failed to create modal elements');
        return;
      }
    }

    const title = trigger.dataset.title;
    const description = trigger.dataset.description;
    const tag = trigger.dataset.tag;
    const productUrl = trigger.dataset.productUrl;
    const productTitle = trigger.dataset.productTitle;
    const imageUrl = trigger.dataset.imageUrl;
    const videoUrl = trigger.dataset.videoUrl;
    const videoType = trigger.dataset.videoType;
    const hasVideo = trigger.dataset.hasVideo === 'true';
    // Update content
    this.querySelector('.instagram-modal-title').textContent = title;
    this.querySelector('.instagram-modal-description').textContent = description;
    this.querySelector('.instagram-modal-tag').textContent = tag;
    
    // Update product link
    // Move product list HTML if visible
    const modalProductsList = this.querySelector('.js-instagram-modal-products-list');
    // Get the corresponding visible js-instagram-products-list from the grid
    const allProductsLists = document.querySelectorAll('.js-instagram-products-list');
    let blockIndex = index;
    if (triggers[blockIndex]) {
      // Find the .js-instagram-products-list inside the corresponding grid item (preferring visible one)
      const container = triggers[blockIndex].closest('.instagram-item');
      const gridProductsList = container ? container.querySelector('.js-instagram-products-list') : null;
      // If it exists and is visible, use its HTML
      if (gridProductsList && gridProductsList.offsetParent !== null) {
        modalProductsList.innerHTML = gridProductsList.innerHTML;
      } else {
        modalProductsList.innerHTML = '';
      }
    } else {
      modalProductsList.innerHTML = '';
    }
    
    // Update counter
    this.querySelector('.current-slide').textContent = index + 1;

    // Hide loading state if it was shown
    this.hideLoadingState();

    // Handle media using preloaded content
    // Note: imageContainer, videoContainer, and video are already declared above

    if (hasVideo && videoUrl) {
      console.log('videoUrl', videoUrl);
      if (videoType === 'youtube' || videoType === 'vimeo') {
        // Show embedded video for YouTube/Vimeo
        imageContainer.style.display = 'none';
        videoContainer.style.display = 'block';

        // Create embedded video iframe
        const embedUrl = this.getEmbedUrl(videoUrl, videoType);
        videoContainer.innerHTML = `
          <iframe 
            src="${embedUrl}" 
            frameborder="0" 
            allowfullscreen
            style="width: 100%; height: 100%;"
          ></iframe>
        `;
        this.currentVideo = null; // No video controls for embedded videos
      } else {
        // Show MP4 video
        imageContainer.style.display = 'none';
        videoContainer.style.display = 'block';

        // Use preloaded video if available
        const preloadedData = this.preloadedMedia.get(index);
        if (preloadedData && preloadedData.type === 'video' && !preloadedData.failed) {
          // Clone the preloaded video to avoid conflicts
          const preloadedVideo = preloadedData.element;
          video.src = preloadedVideo.src;
          video.poster = preloadedVideo.poster;
          video.currentTime = 0; // Reset to beginning
          this.currentVideo = video;
        } else {
          // Fallback to original method if not preloaded or failed
          video.src = videoUrl;
          video.poster = imageUrl;
          this.currentVideo = video;
        }

        // Reset video controls
        this.isVideoMuted = true;
        this.isVideoPlaying = false;
        this.updateVideoControls();

        // Auto play
        video.play().then(() => {
          this.isVideoPlaying = true;
          this.updateVideoControls();
        }).catch(() => {
          // Auto-play failed, show play button
          this.isVideoPlaying = false;
          this.updateVideoControls();
        });
      }
    } else {
      console.log('imageUrl 111111', imageUrl);
      // Show image
      imageContainer.style.display = 'block';
      videoContainer.style.display = 'none';
      
      // Use preloaded image if available
      const preloadedData = this.preloadedMedia.get(index);
      if (preloadedData && preloadedData.type === 'image' && !preloadedData.failed) {
        const preloadedImg = preloadedData.element;
        imageContainer.innerHTML = `<img src="${preloadedImg.src}" alt="${title}" class="instagram-modal-image">`;
      } else {
        // Fallback to original method if not preloaded or failed
        imageContainer.innerHTML = `<img src="${imageUrl}" alt="${title}" loading="lazy" class="instagram-modal-image">`;
      }
      this.currentVideo = null;
    }
  }

  prevSlide() {
    if (this.currentIndex > 0) {
      this.pauseCurrentVideo();
      this.currentIndex--;
      this.loadSlide(this.currentIndex);
    }
  }

  nextSlide() {
    if (this.currentIndex < this.totalBlocks - 1) {
      this.pauseCurrentVideo();
      this.currentIndex++;
      this.loadSlide(this.currentIndex);
    }
  }

  pauseCurrentVideo() {
    if (this.currentVideo) {
      this.currentVideo.pause();
      this.isVideoPlaying = false;
      this.updateVideoControls();
    } else {
      // Handle embedded videos (YouTube/Vimeo)
      const iframe = this.querySelector('.instagram-modal-video-container iframe');
      if (iframe) {
        // For embedded videos, we can't directly control them, but we can remove the iframe
        // and recreate it when needed to "pause" the video
        iframe.style.display = 'none';
      }
    }
  }

  toggleSound() {
    if (this.currentVideo) {
      this.isVideoMuted = !this.isVideoMuted;
      this.currentVideo.muted = this.isVideoMuted;
      this.updateVideoControls();
    }
  }

  togglePlay() {
    if (this.currentVideo) {
      if (this.isVideoPlaying) {
        this.currentVideo.pause();
        this.isVideoPlaying = false;
      } else {
        this.currentVideo.play();
        this.isVideoPlaying = true;
      }
      this.updateVideoControls();
    }
  }

  updateVideoControls() {
    const soundBtn = this.querySelector('[data-sound-toggle]');
    const playBtn = this.querySelector('[data-play-toggle]');
    
    // Only show controls for MP4 videos, not embedded videos
    if (this.currentVideo) {
      soundBtn.style.display = 'flex';
      playBtn.style.display = 'flex';
      
      const mutedIcon = soundBtn.querySelector('.sound-icon.muted');
      const unmutedIcon = soundBtn.querySelector('.sound-icon.unmuted');
      const playIcon = playBtn.querySelector('.play-icon');
      const pauseIcon = playBtn.querySelector('.pause-icon');

      // Update sound button
      if (this.isVideoMuted) {
        mutedIcon.style.display = 'block';
        unmutedIcon.style.display = 'none';
      } else {
        mutedIcon.style.display = 'none';
        unmutedIcon.style.display = 'block';
      }

      // Update play button
      if (this.isVideoPlaying) {
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
      } else {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      }
    } else {
      // Hide controls for embedded videos
      soundBtn.style.display = 'none';
      playBtn.style.display = 'none';
    }
  }
}

// Register the web component
customElements.define('instagram-modal', InstagramModal);
</script>

{% schema %}
{
  "name": "Instagram Feed",
  "tag": "section",
  "class": "section",
  "max_blocks": 12,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Instagram Feed",
      "label": "Heading"
    },
    {
      "type": "text",
      "id": "subheading",
      "default": "Follow us on Instagram for the latest updates and behind-the-scenes content",
      "label": "Subheading"
    },
    {
      "type": "select",
      "id": "content_alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center",
      "label": "Content alignment"
    },
		{
			"type": "header",
			"content": "Layout"
		},
		{
			"type": "select",
			"id": "item_per_row",
			"options": [
				{
					"value": "3",
					"label": "3"
				},
				{
					"value": "4",
					"label": "4"
				},
				{
					"value": "5",
					"label": "5"
				},
				{
					"value": "6",
					"label": "6"
				}
			],
			"default": "3",
			"label": "Item per row"
		},
    {
      "type": "range",
      "id": "grid_gap",
      "min": 0,
      "max": 32,
      "step": 1,
      "unit": "px",
      "label": "Grid gap",
      "default": 16
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "instagram_post",
      "name": "Instagram Post",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
				{
					"type": "video",
					"id": "video",
					"label": "Video"
				},
        {"type": "checkbox",
          "id": "show_title",
          "default": true,
          "label": "Show title"
        },
        {
          "type": "text",
          "id": "title",
          "default": "Instagram Post Title",
          "label": "Title"
        },
        {
          "type": "richtext",
          "id": "description",
          "default": "<p>Share your Instagram post description here. This can include hashtags, mentions, and any other details about your post.</p>",
          "label": "Description"
        },
        {
          "type": "text",
          "id": "tag",
          "default": "#fashion",
          "label": "Tag"
        },
        {
          "type": "product_list",
          "id": "product_list",
          "limit": 4,
          "label": "Product list"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Instagram Feed",
      "blocks": [
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        }
      ]
    }
  ]
}
{% endschema %}
